<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Publications — Alexandra A. de Sousa</title>
<meta name="description" content="Filterable publications by Type, topic Labels (multi-tag AND/OR), Year, and Search.">

<style>
  :root{
    --bg:#f9f9f9; --card:#fff; --text:#222; --muted:#666;
    --accent:#0a65c0; --accent-dark:#084f96; --border:#e6e6e6;
    --chip:#eef4ff; --chip-text:#0a3d7a;
  }
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;}
  .container{max-width:950px;margin:40px auto;padding:0 20px;}
  h1{margin:0 0 12px;font-size:2rem}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
  #filters{display:grid;grid-template-columns:1fr;gap:16px;margin:18px 0}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .controls label{font-weight:600}
  select,input[type="search"]{padding:8px 10px;border:1px solid var(--border);border-radius:8px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--border);border-radius:999px;background:#fff;color:var(--accent-dark);padding:6px 10px;cursor:pointer;font-weight:600}
  .chip.active{background:var(--chip);color:var(--chip-text);border-color:#d6e6ff}
  .links{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .link{color:var(--accent-dark);text-decoration:underline;cursor:pointer}
  .link:focus,.link:hover{color:var(--accent)}
  .pub{border-bottom:1px solid var(--border);padding:14px 0}
  .pub:last-child{border-bottom:0}
  .pub .title{font-weight:700}
  .pub .meta{color:var(--muted);font-size:.95rem}
  .label-list{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px}
  .label{font-size:.8rem;border:1px solid var(--border);border-radius:999px;padding:3px 8px;color:var(--accent-dark);background:#fff}
  .type-badge{margin-left:6px;font-size:.75rem;background:#f3f6fb;border:1px solid #d9e4f5;border-radius:6px;padding:2px 6px;color:#084f96}
  .empty{color:var(--muted);text-align:center;padding:20px}
</style>
</head>
<body>
<div class="container" id="pubs-app">
  <header>
    <h1>Publications</h1>
    <p class="meta">Use the controls to filter by <strong>Type</strong>, <strong>Year</strong>, and <strong>Search</strong>. Topic <strong>Labels</strong> are the only buttons and support ANY/ALL logic.</p>
  </header>

  <!-- FILTERS -->
  <section id="filters" class="card">
    <!-- All non-label filters grouped together -->
    <div class="controls" id="nonLabelFilters">
      <label for="typeSel">Type:</label>
      <select id="typeSel"><option value="">All types</option></select>

      <label for="year">Year:</label>
      <select id="year"><option value="">All years</option></select>

      <label for="logicSel">Label logic:</label>
      <select id="logicSel">
        <option value="any" selected>ANY (match any selected label)</option>
        <option value="all">ALL (must match all selected labels)</option>
      </select>

      <label for="q">Search:</label>
      <input type="search" id="q" placeholder="Title / authors / venue…" />
    </div>

    <!-- Labels: the only buttons -->
    <div>
      <div style="font-weight:600;margin-bottom:6px">Labels:</div>
      <div class="chips" id="labelChips"></div>
    </div>

    <!-- Utility links -->
    <div class="links">
      <a href="#" id="clearLink" class="link">Clear filters</a>
      <a href="#" id="shareLink" class="link">Copy link</a>
    </div>
  </section>

  <!-- RESULTS -->
  <section id="results" class="card" aria-live="polite" aria-busy="false">
    <div id="pubList"></div>
    <div id="empty" class="empty" hidden>No publications match your filters.</div>
  </section>
</div>

<script>
/* ---------- Fetch JSON then initialize ---------- */
fetch('data/publications.json', {cache:'no-store'})
  .then(r => {
    if (!r.ok) throw new Error('Failed to load publications.json');
    return r.json();
  })
  .then(initPublicationsPage)
  .catch(err => {
    console.error(err);
    const container = document.getElementById('pubs-app');
    container.insertAdjacentHTML('beforeend',
      '<p style="color:#b00020">Could not load publications.json. Ensure the file exists at <code>/data/publications.json</code> and is valid JSON.</p>');
  });

/* ---------- Main page logic (data-driven) ---------- */
function initPublicationsPage(data) {
  const norm = s => (s||'').toString().trim().replace(/\s+/g,' ').toLowerCase();
  const labelDisplay = new Map(); // normalized -> first-seen original
  const typeDisplay  = new Map(); // normalized -> first-seen original

  // Normalize labels & type, capture display casing
  data.forEach(p => {
    const labs = Array.isArray(p.labels) ? p.labels : [];
    p.labels = labs.map(l => {
      const n = norm(l);
      if (n && !labelDisplay.has(n)) labelDisplay.set(n, l.toString().trim());
      return n;
    }).filter(Boolean);

    const raw = (p.type ?? '').toString().trim();
    const n = norm(raw) || 'other';
    p.typeNorm = n;
    if (!typeDisplay.has(n)) typeDisplay.set(n, raw || 'Other');
  });

  // Facets
  const labelKeys = Array.from(new Set(data.flatMap(p => p.labels))).sort((a,b)=>a.localeCompare(b));
  const types     = Array.from(new Set(data.map(p => p.typeNorm))).sort((a,b)=>a.localeCompare(b));
  const years     = Array.from(new Set(data.map(p => p.year))).sort((a,b)=>b-a);

  // DOM
  const labelChips = document.getElementById('labelChips');
  const listEl   = document.getElementById('pubList');
  const emptyEl  = document.getElementById('empty');
  const yearSel  = document.getElementById('year');
  const qInput   = document.getElementById('q');
  const logicSel = document.getElementById('logicSel');
  const clearLink= document.getElementById('clearLink');
  const shareLink= document.getElementById('shareLink');
  const typeSel  = document.getElementById('typeSel');

  // Populate selects
  types.forEach(t => typeSel.insertAdjacentHTML('beforeend', `<option value="${t}">${typeDisplay.get(t) || t}</option>`));
  years.forEach(y => yearSel.insertAdjacentHTML('beforeend', `<option value="${y}">${y}</option>`));

  // State
  const state = { type:'', labelsSelected:new Set(), mode:'any', year:'', q:'' };

  // Hash restore
  function restoreFromHash() {
    const h = new URLSearchParams(location.hash.replace(/^#/, ''));
    state.type = norm(h.get('type') || '');
    state.mode = (h.get('mode')==='all') ? 'all' : 'any';
    state.year = h.get('year') || '';
    state.q    = h.get('q') || '';
    const tags = (h.get('tags') || '').split(',').map(norm).filter(Boolean);
    state.labelsSelected = new Set(tags);

    if (!types.includes(state.type)) state.type = '';
    typeSel.value = state.type;
    logicSel.value = state.mode;
    yearSel.value = state.year;
    qInput.value = state.q;
  }

  // Hash write
  function writeHash() {
    const h = new URLSearchParams();
    if (state.type) h.set('type', state.type);
    if (state.labelsSelected.size) h.set('tags', Array.from(state.labelsSelected).join(','));
    if (state.mode==='all') h.set('mode', 'all');
    if (state.year) h.set('year', state.year);
    if (state.q) h.set('q', state.q);
    const s = h.toString();
    history.replaceState(null, '', s ? '#'+s : ' ');
  }

  // Render label chips
  function renderChips() {
    labelChips.innerHTML = labelKeys.map(k => {
      const active = state.labelsSelected.has(k) ? 'active' : '';
      const text = labelDisplay.get(k) || k;
      return `<button class="chip ${active}" data-key="${k}" aria-pressed="${active? 'true':'false'}">${text}</button>`;
    }).join('') || '<span class="meta" style="color:#666">No labels found in data.</span>';
  }

  // Filtering
  function matches(p) {
    const typeOK = state.type ? p.typeNorm === state.type : true;

    const sel = Array.from(state.labelsSelected);
    const have = new Set(p.labels);
    const labelsOK = sel.length === 0
      ? true
      : (state.mode==='any' ? sel.some(t => have.has(t)) : sel.every(t => have.has(t)));

    const yearOK = state.year ? String(p.year) === String(state.year) : true;

    const q = state.q.trim().toLowerCase();
    const text = (p.title + ' ' + p.authors + ' ' + (p.venue||'')).toLowerCase();
    const qOK = q ? text.includes(q) : true;

    return typeOK && labelsOK && yearOK && qOK;
  }

  // Render list (title first; DOI after venue)
  function renderList() {
    const items = data.filter(matches).sort((a,b)=> b.year - a.year || a.title.localeCompare(b.title));
    listEl.innerHTML = items.map(p => {
      const titleHTML = p.url ? `<a href="${p.url}" target="_blank" rel="noopener">${p.title}</a>` : p.title;
      const typeBadge = `<span class="type-badge">${typeDisplay.get(p.typeNorm) || p.typeNorm}</span>`;
      const doiHTML   = p.doi ? ` — DOI: <a href="https://doi.org/${p.doi}" target="_blank" rel="noopener">${p.doi}</a>` : '';
      const labelsHTML= (p.labels||[]).map(k => `<span class="label">${labelDisplay.get(k) || k}</span>`).join('');
      return `
        <article class="pub">
          <div class="title">${titleHTML} ${typeBadge}</div>
          <div class="meta">
            ${p.authors} (${p.year}) ${p.venue ? ' — ' + p.venue : ''}${doiHTML}
          </div>
          <div class="label-list">${labelsHTML}</div>
        </article>
      `;
    }).join('');
    emptyEl.hidden = items.length !== 0;
  }

  // Init + events
  restoreFromHash();
  renderChips();
  renderList();

  labelChips.addEventListener('click', (e) => {
    const b = e.target.closest('.chip'); if (!b) return;
    const key = b.dataset.key;
    state.labelsSelected.has(key) ? state.labelsSelected.delete(key) : state.labelsSelected.add(key);
    renderChips(); writeHash(); renderList();
  });

  typeSel.addEventListener('change', () => { state.type = typeSel.value; writeHash(); renderList(); });
  logicSel.addEventListener('change', () => { state.mode = logicSel.value; writeHash(); renderList(); });
  yearSel.addEventListener('change', () => { state.year = yearSel.value; writeHash(); renderList(); });
  qInput.addEventListener('input', () => { state.q = qInput.value; writeHash(); renderList(); });

  document.getElementById('clearLink').addEventListener('click', (e) => {
    e.preventDefault();
    state.type = '';
    state.labelsSelected.clear();
    state.mode = 'any';
    state.year = '';
    state.q = '';
    typeSel.value = '';
    logicSel.value = 'any';
    yearSel.value = '';
    qInput.value = '';
    renderChips(); writeHash(); renderList();
  });

  document.getElementById('shareLink').addEventListener('click', async (e) => {
    e.preventDefault();
    writeHash();
    try {
      await navigator.clipboard.writeText(location.href);
      const saved = e.target.textContent; e.target.textContent = 'Link copied!';
      setTimeout(()=> e.target.textContent = saved, 1200);
    } catch {}
  });
}
</script>

<noscript>
  <div class="container">
    <p><em>JavaScript is disabled — filtering requires JavaScript.</em></p>
  </div>
</noscript>
</body>
</html>
